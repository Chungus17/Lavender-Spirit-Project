<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body>
  <div class="flex-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="logo">
        <img src="/static/images/logo.svg" alt="Company Logo">
      </div>
      <nav>
        <a href="#projects" class="tab-link active" onclick="showTab('projects')">Projects</a>
        <a href="#users" class="tab-link" onclick="showTab('users')">Users</a>
      </nav>
      <div class="logout">
        <a href="{{ url_for('logout') }}">Logout</a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <button class="hamburger" onclick="toggleSidebar()">☰</button>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="message">{{ message }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Projects Tab -->
      <div id="projects" class="tab-content active">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>All Projects</h2>
          <button onclick="openModal('add-project-modal')">Add Project</button>
        </div>
        <div class="projects-grid">
          {% for project in projects %}
            <div class="project-card">
              <h4>{{ project.title }}</h4>
              <p><strong>Status:</strong> {{ project.status }}</p>
              <img src="{{ url_for('static', filename='uploads/' + project.image_filename) }}" alt="{{ project.title }} Image">
              <p>{{ project.description }}</p>
              <button onclick="openModal('modal{{ project.id }}')">Edit</button>
            </div>

            <!-- Edit Project Modal -->
            <div class="modal" id="modal{{ project.id }}">
              <div class="modal-content">
                <div class="form-header">
                  <h3>Edit Project</h3>
                  <span class="close-btn" onclick="closeModal('modal{{ project.id }}')">×</span>
                </div>

                <form method="POST" action="{{ url_for('admin') }}" enctype="multipart/form-data">
                  <input type="hidden" name="form_type" value="edit">
                  <input type="hidden" name="project_id" value="{{ project.id }}">

                  <div class="form-field">
                    <label>Title:</label>
                    <input type="text" name="title" value="{{ project.title }}" required>
                  </div>

                  <div class="form-field">
                    <label>العنوان</label>
                    <input type="text" name="title_ar" value="{{ project.title_ar }}" required>
                  </div>

                  <div class="form-field">
                    <label>Project Type:</label>
                    <input type="text" name="project_type" value="{{ project.project_type }}" required>
                  </div>

                  <div class="form-field">
                    <label>نوع المشروع</label>
                    <input type="text" name="project_type_ar" value="{{ project.project_type_ar }}" required>
                  </div>

                  <div class="form-field">
                    <label>Status:</label>
                    <select name="status" required>
                      <option value="Planning" {% if project.status == 'Planning' %}selected{% endif %}>Planning</option>
                      <option value="In Progress" {% if project.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                      <option value="Completed" {% if project.status == 'Completed' %}selected{% endif %}>Completed</option>
                    </select>
                  </div>

                  <div class="form-field">
                    <label>الحالة</label>
                    <select name="status_ar" required>
                      <option value="التخطيط" {% if project.status_ar == 'التخطيط' %}selected{% endif %}>التخطيط</option>
                      <option value="جاري التنفيز" {% if project.status_ar == 'جاري التنفيز' %}selected{% endif %}>جاري التنفيز</option>
                      <option value="متكمل" {% if project.status_ar == 'متكمل' %}selected{% endif %}>متكمل</option>
                    </select>
                  </div>

                  <div class="form-field">
                    <label>Description:</label>
                    <textarea name="description" required>{{ project.description }}</textarea>
                  </div>

                  <div class="form-field">
                    <label>الوصف</label>
                    <textarea name="description_ar" required> {{ project.description_ar }}</textarea>
                  </div>

                  <div class="form-field">
                    <label>Replace Image:</label>
                    <input type="file" name="image_file">
                  </div>

                  <div class="form-field">
                    <p>Current Image:</p>
                    <img src="{{ project.image_filename }}" style="width: 100px;">
                  </div>

                  <input type="submit" value="Save Changes">
                </form>
              </div>
            </div>
          {% endfor %}
        </div>

        <!-- Add Project Modal -->
        <div class="modal" id="add-project-modal">
          <div class="modal-content">
            <div class="form-header">
              <h3>Add New Project</h3>
              <span class="close-btn" onclick="closeModal('add-project-modal')">×</span>
            </div>
            <form method="POST" action="{{ url_for('admin') }}" enctype="multipart/form-data">
              <input type="hidden" name="form_type" value="create">

              <div class="form-field">
                <label>Title:</label>
                <input type="text" name="title" required>
              </div>

              <div class="form-field">
                <label>العنوان</label>
                <input type="text" name="title_ar" required>
              </div>

              <div class="form-field">
                <label>Project Type:</label>
                <input type="text" name="project_type" required>
              </div>

              <div class="form-field">
                <label>نوع المشروع</label>
                <input type="text" name="project_type_ar" required>
              </div>

              <div class="form-field">
                <label>Status:</label>
                <select name="status" required>
                  <option value="Planning">Planning</option>
                  <option value="In Progress">In Progress</option>
                  <option value="Completed">Completed</option>
                </select>
              </div>

              <div class="form-field">
                <label>الحالة</label>
                <select name="status_ar" required>
                  <option value="التخطيط">التخطيط</option>
                  <option value="جاري التنفيز">جاري التنفيز</option>
                  <option value="متكمل">متكمل</option>
                </select>
              </div>

              <div class="form-field">
                <label>Description:</label>
                <textarea name="description" required></textarea>
              </div>

              <div class="form-field">
                <label>الوصف</label>
                <textarea name="description_ar" required></textarea>
              </div>

              <div class="form-field">
                <label>Image:</label>
                <input type="file" name="image_file" required>
              </div>

              <input type="submit" value="Add Project">
            </form>
          </div>
        </div>
      </div>

      <!-- Users Tab -->
      <div id="users" class="tab-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>All Users</h2>
          {% if current_user.role == 'admin' %}
            <button onclick="openModal('add-user-modal')">Add User</button>
          {% endif %}
        </div>
        <table class="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for user in users %}
              <tr>
                <td>{{ user.username }}</td>
                <td>{{ user.role }}</td>
                <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>
                  {% if current_user.role == 'admin' or current_user.id == user.id %}
                    <button onclick="openModal('edit-user-modal{{ user.id }}')">Edit</button>
                  {% endif %}
                </td>
              </tr>

              <!-- Edit User Modal -->
              <div class="modal" id="edit-user-modal{{ user.id }}">
                <div class="modal-content">
                  <div class="form-header">
                    <h3>Edit User</h3>
                    <span class="close-btn" onclick="closeModal('edit-user-modal{{ user.id }}')">×</span>
                  </div>
                  <form method="POST" action="{{ url_for('edit_user') }}">
                    <input type="hidden" name="user_id" value="{{ user.id }}">

                    <div class="form-field">
                      <label>Username:</label>
                      <input type="text" name="username" value="{{ user.username }}" required>
                    </div>

                    <div class="form-field">
                      <label>Password (leave blank to keep unchanged):</label>
                      <input type="password" name="password">
                    </div>

                    <div class="form-field">
                      <label>Confirm Password:</label>
                      <input type="password" name="confirm_password">
                    </div>

                    {% if current_user.role == 'admin' %}
                      <div class="form-field">
                        <label>Role:</label>
                        <select name="role" required>
                          <option value="user" {% if user.role == 'user' %}selected{% endif %}>User</option>
                          <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                        </select>
                      </div>
                    {% endif %}

                    <input type="submit" value="Save Changes">
                  </form>

                </div>
              </div>
            {% endfor %}
          </tbody>
        </table>

        <!-- Add User Modal -->
        {% if current_user.role == 'admin' %}
          <div class="modal" id="add-user-modal">
            <div class="modal-content">
              <div class="form-header">
                <h3>Add New User</h3>
                <span class="close-btn" onclick="closeModal('add-user-modal')">×</span>
              </div>
              <form method="POST" action="{{ url_for('add_user') }}">
                <div class="form-field">
                  <label>Username:</label>
                  <input type="text" name="username" required>
                </div>

                    <div class="form-field">
                      <label>Password</label>
                      <input type="password" name="password">
                    </div>

                    <div class="form-field">
                      <label>Confirm Password:</label>
                      <input type="password" name="confirm_password">
                    </div>

                <div class="form-field">
                  <label>Role:</label>
                  <select name="role" required>
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                  </select>
                </div>

                <input type="submit" value="Add User">
              </form>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    function showTab(tab) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab-link').forEach(link => {
        link.classList.remove('active');
      });
      document.getElementById(tab).classList.add('active');
      document.querySelector(`a[href="#${tab}"]`).classList.add('active');
      if (window.innerWidth <= 1024) {
        toggleSidebar(); // Close sidebar on tab change for mobile
      }
    }

    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('active');
    }

    window.onclick = function(event) {
      const modals = document.querySelectorAll('.modal');
      modals.forEach(modal => {
        if (event.target === modal) {
          modal.classList.remove('show');
        }
      });
      const sidebar = document.getElementById('sidebar');
      if (window.innerWidth <= 1024 && !sidebar.contains(event.target) && !event.target.classList.contains('hamburger') && sidebar.classList.contains('active')) {
        sidebar.classList.remove('active');
      }
    }
  </script>
</body>
</html>